<ion-content class="profile-bg">
  <div class="profile-wrapper">

    <div class="profile-header-card">
      <div class="avatar-wrapper">
        <img [src]="avatarUrl" alt="avatar" class="profile-avatar" />
      </div>

      <div class="profile-info">
        <h1 class="profile-title">{{ titleText }}</h1>
        <p class="profile-subtitle" *ngIf="viewedUser">
          @{{ viewedUser.username }}
          <span *ngIf="viewedUser.created_at">
            · desde {{ viewedUser.created_at | date : 'dd/MM/yyyy' }}
          </span>
        </p>
      </div>
    </div>

    <!--Orden por valoración-->
    <div class="order-card">
      <ion-segment [value]="order" (ionChange)="onOrderChange($event)">
        <ion-segment-button value="desc">
          <ion-label>Mejor valoradas</ion-label>
        </ion-segment-button>
        <ion-segment-button value="asc">
          <ion-label>Peor valoradas</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!--Reseñas-->
    <div class="reviews-card">
      <p class="no-reviews" *ngIf="reviews.length === 0">
        Este usuario todavía no tiene reseñas.
      </p>

      <div
        class="review-item"
        *ngFor="let r of reviews"
        (click)="selectReview(r)"
        [class.review-selected]="isCurrentUser && selectedReview?.id === r.id"
      >
        <div class="review-main">
          <div class="review-header">
            <h3 class="review-book">{{ r.book_title }}</h3>
            <div class="review-rating">
              Valoración: {{ r.rating }}/10
            </div>
          </div>

          <p class="review-date">
            {{ r.created_at | date : 'dd/MM/yyyy HH:mm' }}
          </p>

          <p class="review-comment" *ngIf="r.comment">
            {{ r.comment }}
          </p>
        </div>

        <img
          *ngIf="r.book_image"
          [src]="r.book_image"
          alt="portada"
          class="review-image"
        />
      </div>
    </div>

    <!--editar reseñas-->
    <div class="edit-card" *ngIf="isCurrentUser">
      <h2 class="edit-title">Editar / borrar reseña</h2>

      <p class="edit-selected" *ngIf="!selectedReview">
        Toca una reseña de la lista para editarla.
      </p>

      <p class="edit-subtitle" *ngIf="selectedReview">
        Editando reseña de:
        <strong>{{ selectedReview.book_title }}</strong>
      </p>

      <label class="field-label">Valoración (0 - 10)</label>
      <ion-input
        type="number"
        class="input-basic"
        [(ngModel)]="editRating"
        min="0"
        max="10"
      ></ion-input>

      <label class="field-label">Comentario</label>
      <ion-textarea
        class="input-basic textarea-basic"
        auto-grow="true"
        [(ngModel)]="editComment"
      ></ion-textarea>

      <div class="edit-buttons">
        <button class="btn-update" (click)="updateSelectedReview()">
          Actualizar
        </button>

        <button class="btn-delete" (click)="deleteSelectedReview()">
          Eliminar
        </button>

        <button class="btn-clear" (click)="clearSelection()">
          Limpiar selección
        </button>

      <!--Volver-->
        <div class="back-btn-container">
          <ion-button
            expand="block"
            class="back-btn"
            (click)="goBackToBooks()"
          >
            VOLVER A LA LISTA DE LIBROS
          </ion-button>
        </div>
      </div>
    </div>

  </div>
</ion-content>
